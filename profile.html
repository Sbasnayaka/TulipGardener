<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Tulip Gardener</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="welcome-bg-body">
    <!-- Falling Petals Background (from Menu) -->
    <div class="petals-container"></div>

    <!-- Top Navigation -->
    <header class="welcome-top-nav">
        <div class="nav-brand">
            <div class="brand-hexagon">
                <img src="assets/logo.png" alt="Tulip Logo" style="width: 24px; height: 24px; object-fit: contain;">
            </div>
            <span>Tulip Gardener</span>
        </div>

        <div class="nav-center-pill">
            <a href="menu.html" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Menu
            </a>
            <a href="dashboard.html" class="nav-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
                Dashboard
            </a>
            <!-- Active Pill -->
            <a href="profile.html" class="nav-item active">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Profile
            </a>
        </div>

        <div class="nav-actions">
            <!-- Nav Actions Empty / Kept for spacing structure or global consistency -->
            <button class="icon-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
            <button class="icon-btn" onclick="AuthController.handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="profile-main-layout">
        <div class="profile-glass-card">

            <!-- Left Pane: Avatar Box -->
            <div class="prof-col prof-col-left">
                <div class="prof-avatar-ring">
                    <img id="profile-avatar" src="" alt="Avatar">
                    <div class="prof-leaf-badge">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#2b1a37" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2C7 2 3 6 3 11c0 3 2 6 4 9h10c2-3 4-6 4-9 0-5-4-9-9-9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- 3 Static Decorative Badges -->
                <div class="prof-badges-row">
                    <div class="p-mini-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#87eb8f" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2C7 2 3 6 3 11c0 3 2 6 4 9h10c2-3 4-6 4-9 0-5-4-9-9-9z"></path>
                        </svg>
                    </div>
                    <div class="p-mini-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ffca28" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </div>
                    <div class="p-mini-badge active-star-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#B347FF" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polygon
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                            </polygon>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Right Pane: Stats Grid -->
            <div class="prof-col prof-col-right">

                <!-- Header Block -->
                <div class="prof-header-row">
                    <div class="prof-title-block">
                        <h1 id="p-username" class="prof-username-text">Loading...</h1>
                        <div class="prof-level-tag">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#B347FF"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            <span id="p-level">Beginner</span>
                        </div>
                    </div>
                    <!-- Dummy Button for UX completeness based on sketch -->
                    <button class="prof-edit-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                        Edit Profile
                    </button>
                </div>

                <div class="prof-divider-line"></div>

                <!-- 2x2 Data Grid -->
                <div class="prof-stats-grid">

                    <!-- Card 1 -->
                    <div class="prof-stat-box">
                        <div class="prof-stat-icon-wrapper" style="color: #A013EC;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                            </svg>
                        </div>
                        <span class="prof-stat-label">CURRENT SCORE</span>
                        <h2 class="prof-stat-value" id="p-score">0</h2>
                        <span class="prof-stat-sub">Top 5% this week</span>
                    </div>

                    <!-- Card 2 -->
                    <div class="prof-stat-box">
                        <div class="prof-stat-icon-wrapper" style="color: #87eb8f;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2C7 2 3 6 3 11c0 3 2 6 4 9h10c2-3 4-6 4-9 0-5-4-9-9-9z"></path>
                            </svg>
                        </div>
                        <span class="prof-stat-label">TOTAL TULIPS</span>
                        <h2 class="prof-stat-value" id="p-tulips">0</h2>
                        <span class="prof-stat-sub">12 rare species found</span>
                    </div>

                    <!-- Card 3 -->
                    <div class="prof-stat-box">
                        <div class="prof-stat-icon-wrapper" style="color: #64b5f6;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <span class="prof-stat-label">BEST RECORD</span>
                        <h2 class="prof-stat-value" id="p-best">0</h2>
                        <span class="prof-stat-sub">Speed run challenge</span>
                    </div>

                    <!-- Card 4 -->
                    <div class="prof-stat-box">
                        <div class="prof-stat-icon-wrapper" style="color: #ffb74d;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path
                                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                                </path>
                            </svg>
                        </div>
                        <span class="prof-stat-label">PLAYER RANK</span>
                        <h2 class="prof-stat-value" id="p-rank">#--</h2>
                        <span class="prof-stat-sub">Up from #55</span>
                    </div>

                </div>

                <!-- Bottom Progress Bar Section -->
                <div class="prof-progress-section">
                    <div class="prof-prog-headers">
                        <div>
                            <span class="prof-milestone-title">Next Milestone: Golden Trowel</span>
                            <span class="prof-milestone-sub" id="p-milestone-sub">Collect more tulips to unlock</span>
                        </div>
                        <span class="prof-prog-percent" id="p-percent">0%</span>
                    </div>
                    <div class="prof-prog-track">
                        <div class="prof-prog-fill" id="p-prog-fill" style="width: 0%;"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Architecture -->
    <script src="js/services/supabaseClient.js"></script>
    <script src="js/services/UserService.js"></script>
    <script src="js/controllers/AuthController.js"></script>

    <!-- Background Petal Rain (Shared logic from menu.html) -->
    <script>
        function createShinyPetals() {
            const container = document.querySelector('.petals-container');
            if (!container) return;
            const petalCount = 120; // Generating over 100 petals

            for (let i = 0; i < petalCount; i++) {
                const petal = document.createElement('div');
                petal.classList.add('shiny-petal');

                const leftPos = Math.random() * 100;
                const animDuration = Math.random() * 12 + 8;
                const animDelay = Math.random() * 10;
                const scale = Math.random() * 0.2 + 0.1;

                petal.style.left = `${leftPos}vw`;
                petal.style.animationDuration = `${animDuration}s`;
                petal.style.animationDelay = `-${animDelay}s`;
                petal.style.setProperty('--scale-factor', scale);

                const initialRotation = Math.random() * 360;
                petal.style.setProperty('--rot-start', `${initialRotation}deg`);
                petal.style.setProperty('--rot-end', `${initialRotation + (Math.random() > 0.5 ? 360 : -360)}deg`);

                container.appendChild(petal);
            }
        }
        createShinyPetals();

        // Core Profile Logic
        async function loadProfile() {
            const authed = await AuthController.requireAuth();
            if (!authed) return;

            try {
                const profile = await UserService.getProfile();
                document.getElementById('p-username').innerText = profile.username || 'Player';
                document.getElementById('p-score').innerText = profile.score || 0;
                document.getElementById('p-tulips').innerText = profile.score || 0;
                document.getElementById('p-best').innerText = profile.best_record || 0;

                if (profile.avatar_url && profile.avatar_url !== 'null' && profile.avatar_url !== 'undefined') {
                    document.getElementById('profile-avatar').src = decodeURIComponent(profile.avatar_url);
                } else {
                    // Fallback visually if no avatar is supplied
                    document.getElementById('profile-avatar').style.display = 'none';
                    document.querySelector('.prof-avatar-ring').style.background = '#A013EC';
                }

                // Level calculation imported logically from existing Dashboard
                let level = 'Beginner';
                if (profile.score >= 6) level = 'Pro';
                else if (profile.score >= 3) level = 'Intermediate';
                document.getElementById('p-level').innerText = level;

                // Fake "Rank" computation since no leaderboard endpoint is formally spec'd right now
                // Purely visual mapping to score so it feels alive
                document.getElementById('p-rank').innerText = '#' + Math.max(1, (1000 - (profile.score * 5)));

                // Milestone progress calculation Logic
                let nextGoal = 50;
                if (profile.score > 50) nextGoal = 150;
                if (profile.score > 150) nextGoal = 500;

                let percent = Math.min(100, Math.floor((profile.score / nextGoal) * 100));
                let remaining = nextGoal - profile.score;

                document.getElementById('p-percent').innerText = `${percent}%`;
                document.getElementById('p-prog-fill').style.width = `${percent}%`;

                if (remaining > 0) {
                    document.getElementById('p-milestone-sub').innerText = `Collect ${remaining} more tulips to unlock`;
                } else {
                    document.getElementById('p-milestone-sub').innerText = `Milestone unlocked!`;
                }


            } catch (e) {
                console.error('Profile load error:', e);
            }
        }

        loadProfile();
    </script>
</body>

</html>